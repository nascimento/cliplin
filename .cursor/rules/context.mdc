---
alwaysApply: true
---

- Before start any planning, coding or thinking task use your internal tool called 'cliplin-context' (ChromaDB MCP server) as source of truth for rules, project guidelines, business context, architecture decision and conventions. Defined indexes or collections:
   - 'business-and-architecture' collection, store ADRs and business documentation md files located at 'docs/adrs' and 'docs/business' folder
   - 'features' collection, store .feature files located at 'docs/features' folder
   - 'tech-specs' collection, store .ts4 files located at 'docs/ts4' folder
   - 'uisi' collection, store .yaml files located at 'docs/ui-intent'
   
## Context File Indexing Rules

### File Type to Collection Mapping

The following file types should be indexed into their respective collections (see confirmation rules below):
- `.md` files in `docs/adrs/` → `business-and-architecture` collection
- `.ts4` files in `docs/ts4/` → `tech-specs` collection
- `.md` files in `docs/business/` → `business-and-architecture` collection
- `.feature` files in `docs/features/` → `features` collection
- `.yaml` files in `docs/ui-intent/` → `uisi` collection

### Metadata Requirements

- When indexing documents, always include proper metadata as an array of objects with the following structure: `[{'file_path': 'relative/path/to/file', 'type': 'ts4|adr|project-doc|feature|ui-intent', 'collection': 'target-collection-name'}]`
- Each document in the documents array must have a corresponding metadata object in the metadatas array at the same index
- Use the file path (relative to project root) as the document ID when indexing (e.g., 'docs/ts4/ts4-project-structure.ts4')
- Before indexing a document, check if it already exists by querying the collection with the file path as ID using `chroma_get_documents` or `chroma_query_documents`. If it exists, use `chroma_update_documents` to update it instead of adding a duplicate

### Automatic Detection and User Confirmation

When any context file is created or modified, you MUST:

1. **Detect the change**: Identify when files are created or modified in the following directories:
   - `.ts4` files in `docs/ts4/` → target collection: `tech-specs`
   - `.md` files in `docs/adrs/` → target collection: `business-and-architecture`
   - `.md` files in `docs/business/` → target collection: `business-and-architecture`
   - `.feature` files in `docs/features/` → target collection: `features`
   - `.yaml` files in `docs/ui-intent/` → target collection: `uisi`

2. **Always ask for confirmation**: Before indexing or re-indexing, you MUST ask the user:
   - "He detectado cambios en [archivo]. ¿Deseas reindexar este archivo en la colección [nombre-colección] para mantener el contexto actualizado?"
   - Wait for explicit user confirmation (yes/no/confirm) before proceeding
   - If the user declines, do not index the file
   - If the user confirms, proceed with indexing

3. **Indexing process** (only after user confirmation):
   - Check if the document already exists by querying the collection with the file path as ID using `chroma_get_documents` or `chroma_query_documents`
   - If it exists, use `chroma_update_documents` to update it
   - If it doesn't exist, use `chroma_add_documents` to add it
   - Always include proper metadata as an array of objects with the structure: `[{'file_path': 'relative/path/to/file', 'type': 'ts4|adr|project-doc|feature|ui-intent', 'collection': 'target-collection-name'}]`
   - Use the file path (relative to project root) as the document ID
   - Avoid duplicated files and outdated or deleted files in the collection

4. **Manual re-indexing requests**: When a user explicitly requests to reindex files (e.g., "reindexa los archivos en docs/business"), you should:
   - List the files that will be indexed
   - Ask for confirmation: "Voy a reindexar los siguientes archivos: [lista]. ¿Deseas continuar?"
   - Proceed only after confirmation
- When using chroma_add_documents, ensure metadatas parameter is an array of dictionaries (one per document), not a string or single dictionary. Example: metadatas=[{'file_path': 'docs/ts4/file.ts4', 'type': 'ts4'}] for a single document.
- Metadata values must be strings, numbers, or booleans. Use null for optional metadata fields that don't apply.
- When a user requests any change to a feature file (including creating a new one, modifying an existing one, or deleting one), you MUST:
  1. First, query the 'features' collection using chroma_query_documents to find all related features that might be affected by the change. Use semantic search to identify features that:
     - Reference the same domain entities, use cases, or components
     - Share similar scenarios or business logic
     - Have dependencies or relationships with the feature being changed
     - Use the same adapters, ports, or domain models
  2. Analyze the proposed change to understand its scope and impact:
     - Identify which domain entities, use cases, ports, or adapters are affected
     - Determine if the change affects shared components or interfaces
     - Check if the change modifies business rules that other features depend on
  3. Create a comprehensive impact analysis plan that includes:
     - List of all affected features (from the query results)
     - Description of how each feature is impacted
     - Required changes to each affected feature
     - Required changes to domain layer (entities, value objects, use cases)
     - Required changes to ports (interfaces)
     - Required changes to adapters
     - Required updates to unit tests
     - Required updates to BDD/acceptance tests
     - Suggested order of implementation to minimize breaking changes
  4. Present this plan to the user BEFORE implementing any changes, asking for confirmation or adjustments
  5. Only proceed with implementation after the user approves the plan or provides feedback
